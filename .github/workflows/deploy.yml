name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check CurseForge API Access
        env:
          # Injetar via env: evita que o bash expanda os '$' da key quando
          # o GitHub Actions substitui ${{ secrets.* }} no texto do script.
          CF_API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
        run: |
          echo "[deploy] Testando acesso à API do CurseForge (Game ID: 70216)..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "x-api-key: ${CF_API_KEY}" \
            "https://api.curseforge.com/v1/games/70216")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "[deploy] ERRO: API retornou HTTP $HTTP_CODE. Verifique o secret CURSEFORGE_API_KEY."
            exit 1
          fi
          echo "[deploy] API acessível (HTTP 200)."


      - name: Prepare Mod List from CSV
        id: find_ids
        run: |
          if [ ! -f mods.csv ]; then
            echo "[deploy] mods.csv não encontrado."
            echo "project_ids=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Lê mods.csv: filtra linhas onde Habilitado (coluna NF-1) == "Sim"
          # e Project ID (última coluna) é numérico. Usa NF para ser robusto
          # a campos com vírgula no meio do nome.
          MOD_IDS=$(awk -F',' 'NR>1 && $(NF-1)=="Sim" && $NF~/^[0-9]+$/ {printf "%s ", $NF}' mods.csv)
          MOD_IDS="${MOD_IDS% }"  # remove espaço final

          ID_COUNT=$(echo "$MOD_IDS" | tr -s ' ' '\n' | grep -c . || true)
          echo "[deploy] $ID_COUNT Project IDs extraídos de mods.csv."

          if [ -z "$MOD_IDS" ]; then
            echo "[deploy] ERRO: Nenhum Project ID encontrado em mods.csv."
            exit 1
          fi

          echo "project_ids=$MOD_IDS" >> $GITHUB_OUTPUT

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/Paotheon || exit 1

            # Garante que a VPS fique exatamente igual ao remote (ignora divergências locais).
            git fetch origin main
            git reset --hard origin/main

            # IMPORTANTE: printf com aspas simples ao redor do valor evita que o bash
            # expanda os '$' presentes na API key (ex: $2a$10$ viraria a10 com echo "...").
            # O docker-compose lê o .env e passa as variáveis diretamente ao container.
            printf 'CURSEFORGE_API_KEY=%s\n' '${{ secrets.CURSEFORGE_API_KEY }}' > .env
            printf 'MOD_PROJECT_IDS=%s\n' '${{ steps.find_ids.outputs.project_ids }}' >> .env

            docker compose -f docker-compose.yml up -d --build --force-recreate

            docker image prune -f
