name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check CurseForge API Access
        env:
          # Injetar via env: evita que o bash expanda os '$' da key quando
          # o GitHub Actions substitui ${{ secrets.* }} no texto do script.
          CF_API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
        run: |
          echo "[deploy] Testando acesso à API do CurseForge (Game ID: 70216)..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "x-api-key: ${CF_API_KEY}" \
            "https://api.curseforge.com/v1/games/70216")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "[deploy] ERRO: API retornou HTTP $HTTP_CODE. Verifique o secret CURSEFORGE_API_KEY."
            exit 1
          fi
          echo "[deploy] API acessível (HTTP 200)."


      - name: Prepare Mod List from CSV
        id: find_ids
        run: |
          chmod +x scripts/find-mod-ids.sh

          if [ ! -f mods/config.json ]; then
            echo "[deploy] mods/config.json não encontrado, pulando busca de IDs."
            echo "project_ids=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extrai apenas mods com Enabled: true
          ENABLED_MODS=$(jq -r '.Mods | to_entries[] | select(.value.Enabled == true) | .key' mods/config.json)
          MOD_COUNT=$(echo "$ENABLED_MODS" | grep -c . || true)
          echo "[deploy] $MOD_COUNT mods habilitados encontrados em mods/config.json."

          if [ -z "$ENABLED_MODS" ] || [ "$MOD_COUNT" -eq 0 ]; then
            echo "[deploy] Nenhum mod habilitado. Pulando busca de IDs."
            echo "project_ids=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Busca os IDs (logs de detalhe vão para stderr, capturado pelo Actions)
          MOD_IDS=$(scripts/find-mod-ids.sh -q <<< "$ENABLED_MODS" || true)

          ID_COUNT=$(echo "$MOD_IDS" | tr -s ' ' '\n' | grep -c . || true)
          echo "[deploy] IDs encontrados: $ID_COUNT / $MOD_COUNT"

          if [ -z "$MOD_IDS" ]; then
            echo "[deploy] ERRO: Nenhum Project ID retornado para os mods habilitados."
            exit 1
          fi

          echo "project_ids=$MOD_IDS" >> $GITHUB_OUTPUT

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/Paotheon || exit 1

            git pull

            # IMPORTANTE: printf com aspas simples ao redor do valor evita que o bash
            # expanda os '$' presentes na API key (ex: $2a$10$ viraria a10 com echo "...").
            printf 'CURSEFORGE_API_KEY=%s\n' '${{ secrets.CURSEFORGE_API_KEY }}' > .env
            printf 'MOD_PROJECT_IDS=%s\n' '${{ steps.find_ids.outputs.project_ids }}' >> .env

            docker compose -f docker-compose.yml up -d --build

            docker image prune -f
